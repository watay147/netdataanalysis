<!DOCTYPE html>
<html>
<head >
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width,
                                     initial-scale=1.0,
                                     maximum-scale=1.0,
                                     user-scalable=no">

    {% load staticfiles %}
    <title>股票舆情监控系统</title>
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">
    <link href="{% static "css/company.css" %}" rel="stylesheet">
    <script src="{% static "js/jquery-1.11.3.js" %}"></script>
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
    <script src="http://echarts.baidu.com/build/dist/echarts.js"></script>
</head>
<body>
{% include 'indexnav.html' %}
<div class="container">
    {% if company %}
    <div class="row">
        <div class="col-md-4 ">
        <h1>{{ company.name }}</h1>
    </div>
        <div class="col-md-8">
            <h4> {{ company.description }}</h4>

            </div>
    </div>
    <hr/>
    <div class="row">
        <h3>舆情指数与股价变化对比</h3>
        <div id="lineplot" style="height: 400px;">
        </div>
    </div>
    <hr/>
    <div class="row">
        <h3>热点舆情</h3>
        <div class="row">
        {% if event_list %}
        {% for event in event_list %}
        <div class="col-md-6 col-sm-6 col-xs-6">
            <a href="{% url 'viewevent' event.id %}">{{ event.title }}</a>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-6">
            日期：{{event.date}}
        </div>
        {% endfor %}
        {% else %}
        <p>没有舆情事件</p>
        {% endif %}
        </div>
        <div class="row">
        <div id="piechart" style="height: 400px;width=800px;">

        </div>
        </div>
    </div>
    <hr/>
    <div class="row">
        <h3>热点新闻</h3>
        {% if new_list %}
        {% for new in new_list %}
        <div class="col-md-6 col-sm-6 col-xs-6">
            <a href="{% url 'viewnew' new.id %}">{{ new.title }}</a>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-6">
            日期：{{new.date}}
        </div>
        {% endfor %}
        {% else %}
        <p>没有热门新闻</p>
        {% endif %}
    </div>
    <hr/>
    <div class="row">
        <h3>个股提醒</h3>
        </div>
    <hr/>
    {% else %}
    <div>
        没有该公司信息
        </div>
    {% endif %}
</div>
{% include 'footer.html' %}

<script type="text/javascript">
    // 路径配置
    require.config({
        paths: {
            echarts: "{% static "echarts/build/dist" %}"
        }
    });

    // 使用
    require(
            [
                'echarts',
                'echarts/chart/line', // 使用柱状图就加载bar模块，按需加载
                'echarts/chart/pie'

            ],
            function (ec) {
                initlineplot(ec);
                initpiechart(ec);


            }
    );


    function initlineplot(ec){
        // 基于准备好的dom，初始化echarts图表
        var myChart = ec.init(document.getElementById('lineplot'));
        myChart.showLoading({
            text:"图表数据正在努力加载..."
        });
        options = {
            title : {
                text: '{{ company.name }}舆情指数与股价变化对比',
                x: 'center'
            },
            tooltip : {
                trigger: 'axis'
            },
            dataZoom: {
                show: true,
                start : 2
            },
            legend: {
                data:[],
                x:'left',
                selected:{
                    '舆情指数':true,
                    '股价':false
                }
            },
            toolbox: {
                show : true

            },

            xAxis : [
                {
                    type : 'category',
                    data:[]


                }
            ],
            yAxis : [
                {
                    name:'舆情指数',
                    type : 'value',
                    max:1
                },
                {
                    name:'股价(元)',
                    type:'value'
                }
            ],
            series : []


        };
        $.ajax({
            type:"get",
            async:true,
            url:'{% url 'complotdata' %}',
            dataType:"json",
            data:{stockno:'{{company.stockno}}',type:'line'},
            success: function (result) {
                if(result){
                    //将返回的category和series对象赋值给options对象内的category和series
                    //因为xAxis是一个数组 这里需要是xAxis[i]的形式
                    options.xAxis[0].data=result.category;
                    options.series = result.series;
                    options.legend.data = result.legend;
                    myChart.hideLoading();
                    myChart.setOption(options);
                }
            }
        });
    }

    function initpiechart(ec){
        var myChart = ec.init(document.getElementById('piechart'));
        myChart.showLoading({
            text:"图表数据正在努力加载..."
        });
        pieoptions={
            title : {
                text: '各类舆情偏向占比',
                x:'left'
            },
            legend:{
                data:[],
                x:'center'

            },
            calculable : true,
            series :[]
        };
        $.ajax({
            type:"get",
            async:true,
            url:'{% url 'complotdata' %}',
            dataType:"json",
            data:{stockno:'{{company.stockno}}',type:'pie'},
            success: function (result) {
                if(result){

                    pieoptions.series = result.series;
                    pieoptions.legend.data = result.legend;
                    myChart.hideLoading();
                    myChart.setOption(pieoptions);
                }
            }
        });
    }
</script>
</body>
</html>